#!/bin/env sh

if [ "$1" ]; then
	ssid="$1"
	pass="$2"
else
	echo "you need to pass at least one argument e.g:"
	echo "conn_net <ssid>"
	echo "conn_net <ssid> <password>"
	echo "conn_net <ssid> <password> 1"
	echo ""
	echo "to execute this program you need administration powers(worry not, sudo gonna be called either way)"
	echo ""
	exit 1
fi

hidden=0
if [ "$3" ];then
	hidden=1
fi

if [ $(pgrep -f wpa) ];then
	sudo kill -9 "$(pgrep -f wpa)"
fi

conn_folder="/root/.conn_net"
# checks if the folder already exists
# if not create it
if [ ! -d "$conn_folder" ];then
	sudo mkdir "$conn_folder"
fi

conn_file="${conn_folder}/${ssid}"

# if there is a password it does mean that either
# you is changing the password of a existing file
# or is creating a new one, either way gonna be passing here 
if [ "$pass" = "open"  ];then
	sudo sh -c "wpa_passphrase $ssid nopassword | sed "/#.*/s//scan_ssid=$hidden/" | sed '4d' 1> $conn_file"
elif [ "$pass" ];then
	sudo sh -c "wpa_passphrase $ssid $pass | sed "/#.*/s//scan_ssid=$hidden/" 1> $conn_file"
fi


sudo wpa_supplicant -B -i wlan0 -c $conn_file

sleep 0.6s
sudo dhcpcd wlan0
